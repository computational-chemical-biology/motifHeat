library("devtools") 
library("devtools") 
install.packages("devtools")
install.packages("curl")
library("devtools") 
library(roxygen2) 
devtools::install_github("klutometis/roxygen")
library(roxygen2) 
create("motifHeat") 
dir()
dir('motifHeat/')
library(gplots)
install.packages('gplots')
install.packages('bitops')
library(gplots)
tab <- read.csv('../carcara/static/processed/8377b99a-4844-4966-94f9-55ab4505179e/feature_table.csv', stringsAsFactors=FALSE, check.names= FALSE)
meta <- read.delim('../carcara/static/processed/8377b99a-4844-4966-94f9-55ab4505179e/metadata.tsv', stringsAsFactors=FALSE, check.names=FALSE)
meta2 <- meta[meta[,2]=='Burkholderia dolosa AU0645  Genomovar type VI',] 
tab2 <- tab[, grep('Peak area', colnames(tab))] 
tab2 <- t(tab2) 
rownames(tab2) <- sub(' Peak area$', '', rownames(tab2)) 
tab2 <- tab2[meta2[,1],] 
tab2 <- tab2[,apply(tab2, 2, sum)!=0]
extraction_col <- c("darkorchid","darkred") 
names(extraction_col) <- unique(meta2[, 'Extraction'])
extraction_col <- extraction_col[meta2[, 'Extraction']]
antib_col <- c("green","darkgreen") 
names(antib_col) <- unique(meta2[, 'Trimethoprim'])
antib_col <- antib_col[meta2[, 'Trimethoprim']]
rlab=t(cbind(extraction_col,antib_col))
rownames(rlab)=c("Extraction","Antibiotic")
mydist=function(c) {dist(c,method="canberra")} 
myclust=function(c) {hclust(c,method="ward.D")}
heatmap
heatmap.2
heatmap.2(tab2, hclustfun=myclust, distfun=mydist, na.rm = TRUE, scale="column", dendrogram="both", margins=c(6,12),
 Rowv=TRUE, Colv=TRUE,  RowSideColors=rlab, symbreaks=FALSE, key=TRUE, symkey=FALSE,
 density.info="none", trace="none", main="Burkholderia dolosa AU0645  Genomovar type VI", labCol=FALSE, labRow=rownames(tab2), cexRow=1, col=rev(heat.colors(75)),
 ColSideColorsSize=7, RowSideColorsSize=2, KeyValueName="Ion intensity")
source_url("https://raw.githubusercontent.com/obigriffith/biostar-tutorials/master/Heatmaps/heatmap.3.R")
heatmap.2(tab2, hclustfun=myclust, distfun=mydist, na.rm = TRUE, scale="column", dendrogram="both", margins=c(6,12),
 Rowv=TRUE, Colv=TRUE,  RowSideColors=rlab, symbreaks=FALSE, key=TRUE, symkey=FALSE,
 density.info="none", trace="none", main="Burkholderia dolosa AU0645  Genomovar type VI", labCol=FALSE, labRow=rownames(tab2), cexRow=1, col=rev(heat.colors(75)),
 ColSideColorsSize=7, RowSideColorsSize=2, KeyValueName="Ion intensity")
heatmap.3(tab2, hclustfun=myclust, distfun=mydist, na.rm = TRUE, scale="column", dendrogram="both", margins=c(6,12),
 Rowv=TRUE, Colv=TRUE,  RowSideColors=rlab, symbreaks=FALSE, key=TRUE, symkey=FALSE,
 density.info="none", trace="none", main="Burkholderia dolosa AU0645  Genomovar type VI", labCol=FALSE, labRow=rownames(tab2), cexRow=1, col=rev(heat.colors(75)),
 ColSideColorsSize=7, RowSideColorsSize=2, KeyValueName="Ion intensity")
is.null
list()
format_heatmap <- function(featureTable, metadataTable, selectField=NULL, selectValue=NULL,
   factorColList=list(), main='', ...){ 
    if (!is.null(selectField)) {
        meta2 <- meta[meta[,selectField]==selectValue,] 
    } else {
        meta2 <- meta
    }
    
    # Format MZmine feature table
    tab2 <- tab[, grep('Peak area', colnames(tab))] 
    tab2 <- t(tab2) 
    rownames(tab2) <- sub(' Peak area$', '', rownames(tab2)) 
    # order samples according to metadata
    tab2 <- tab2[meta2[,1],] 
    tab2 <- tab2[,apply(tab2, 2, sum)!=0]
   
    colList <- list()
    if (length(factorColList)) { 
        fnames <- c()
for(i in 1:length(factorColList)) {
            colList[[i]] <- factorColList[[1]]$colors 
            names(colList[[i]]) <- unique(meta2[, factorColList[[1]]$factor])
            colList[[i]] <- colList[[i]][meta2[, factorColList[[1]]$factor]]
            fnames <- append(fnames, factorColList[[1]]$factor)
        }
        rlab <- do.call(rbind, colList)
        rownames(rlab) <- fnames 
    } 
    
    mydist <- function(c) { dist(c, method="canberra") } 
    myclust <- function(c) { hclust(c, method="ward.D") }
    
    pdf(paste0(main, '.pdf'))
    heatmap.3(tab2, hclustfun=myclust, distfun=mydist, na.rm = TRUE, scale="column", dendrogram="both", margins=c(6,12),
     Rowv=TRUE, Colv=TRUE,  RowSideColors=rlab, symbreaks=FALSE, key=TRUE, symkey=FALSE,
     density.info="none", trace="none", main=main, labCol=FALSE, labRow=rownames(tab2), cexRow=1, col=rev(heat.colors(75)),
     ColSideColorsSize=7, RowSideColorsSize=2, KeyValueName="Ion intensity", ...)
    dev.off()
}
rev(heat.colors(75)
)
h <- heatmap.3(tab2, hclustfun=myclust, distfun=mydist, na.rm = TRUE, scale="column", dendrogram="both", margins=c(6,12),
 Rowv=TRUE, Colv=TRUE,  RowSideColors=rlab, symbreaks=FALSE, key=TRUE, symkey=FALSE,
 density.info="none", trace="none", main="Burkholderia dolosa AU0645  Genomovar type VI", labCol=FALSE, labRow=rownames(tab2), cexRow=1, col=rev(heat.colors(75)),
 ColSideColorsSize=7, RowSideColorsSize=2, KeyValueName="Ion intensity")
h
plot(h)
h$call
h$rowDendrogram
is.call(h$call)
call(h$call)
is.call(h$call)
?call
eval(h$call)
format_heatmap <- function(featureTable, metadataTable, selectField=NULL, selectValue=NULL,
   factorColList=list(), colorScale=rev(heat.colors(75)), main='', ...){ 
    if (!is.null(selectField)) {
        meta2 <- meta[meta[,selectField]==selectValue,] 
    } else {
        meta2 <- meta
    }
    
    # Format MZmine feature table
    tab2 <- tab[, grep('Peak area', colnames(tab))] 
    tab2 <- t(tab2) 
    rownames(tab2) <- sub(' Peak area$', '', rownames(tab2)) 
    # order samples according to metadata
    tab2 <- tab2[meta2[,1],] 
    tab2 <- tab2[,apply(tab2, 2, sum)!=0]
   
    colList <- list()
    if (length(factorColList)) { 
        fnames <- c()
for(i in 1:length(factorColList)) {
            colList[[i]] <- factorColList[[1]]$colors 
            names(colList[[i]]) <- unique(meta2[, factorColList[[1]]$factor])
            colList[[i]] <- colList[[i]][meta2[, factorColList[[1]]$factor]]
            fnames <- append(fnames, factorColList[[1]]$factor)
        }
        rlab <- do.call(rbind, colList)
        rownames(rlab) <- fnames 
    } 
    
    mydist <- function(c) { dist(c, method="canberra") } 
    myclust <- function(c) { hclust(c, method="ward.D") }
    
    h <- heatmap.3(tab2, hclustfun=myclust, distfun=mydist, na.rm = TRUE, scale="column", dendrogram="both", margins=c(6,12),
     Rowv=TRUE, Colv=TRUE,  RowSideColors=rlab, symbreaks=FALSE, key=TRUE, symkey=FALSE,
     density.info="none", trace="none", main=main, labCol=FALSE, labRow=rownames(tab2), cexRow=1, col=colorScale,
     ColSideColorsSize=7, RowSideColorsSize=2, KeyValueName="Ion intensity", ...)
     return(h)
}
factorColList <- list(list(colors=c("darkorchid","darkred"), factor='Extraction'), list(colors=c("green", "darkgreen"), factor='Trimethoprim'))
colnames(meta)
h <- format_heatmap(tab, meta, selectField='StrainName', selectValue='Burkholderia dolosa AU0645  Genomovar type VI', factorColList=factorColList)
dim(rlab)
rlab[, 1:5]
rlab2 <- rlab
    colList <- list()
    if (length(factorColList)) { 
        fnames <- c()
for(i in 1:length(factorColList)) {
            colList[[i]] <- factorColList[[1]]$colors 
            names(colList[[i]]) <- unique(meta2[, factorColList[[1]]$factor])
            colList[[i]] <- colList[[i]][meta2[, factorColList[[1]]$factor]]
            fnames <- append(fnames, factorColList[[1]]$factor)
        }
        rlab <- do.call(rbind, colList)
        rownames(rlab) <- fnames 
    } 
dim(rlab)
rlab[, 1:5]
format_heatmap <- function(featureTable, metadataTable, selectField=NULL, selectValue=NULL,
   factorColList=list(), colorScale=rev(heat.colors(75)), main='', ...){ 
    if (!is.null(selectField)) {
        meta2 <- meta[meta[,selectField]==selectValue,] 
    } else {
        meta2 <- meta
    }
    
    # Format MZmine feature table
    tab2 <- tab[, grep('Peak area', colnames(tab))] 
    tab2 <- t(tab2) 
    rownames(tab2) <- sub(' Peak area$', '', rownames(tab2)) 
    # order samples according to metadata
    tab2 <- tab2[meta2[,1],] 
    tab2 <- tab2[,apply(tab2, 2, sum)!=0]
   
    colList <- list()
    if (length(factorColList)) { 
        fnames <- c()
for(i in 1:length(factorColList)) {
            colList[[i]] <- factorColList[[i]]$colors 
            names(colList[[i]]) <- unique(meta2[, factorColList[[i]]$factor])
            colList[[i]] <- colList[[i]][meta2[, factorColList[[i]]$factor]]
            fnames <- append(fnames, factorColList[[i]]$factor)
        }
        rlab <- do.call(rbind, colList)
        rownames(rlab) <- fnames 
    } 
    
    mydist <- function(c) { dist(c, method="canberra") } 
    myclust <- function(c) { hclust(c, method="ward.D") }
    
    h <- heatmap.3(tab2, hclustfun=myclust, distfun=mydist, na.rm = TRUE, scale="column", dendrogram="both", margins=c(6,12),
     Rowv=TRUE, Colv=TRUE,  RowSideColors=rlab, symbreaks=FALSE, key=TRUE, symkey=FALSE,
     density.info="none", trace="none", main=main, labCol=FALSE, labRow=rownames(tab2), cexRow=1, col=colorScale,
     ColSideColorsSize=7, RowSideColorsSize=2, KeyValueName="Ion intensity", ...)
     return(h)
}
h <- format_heatmap(tab, meta, selectField='StrainName', selectValue='Burkholderia dolosa AU0645  Genomovar type VI', factorColList=factorColList)
savehistory('format_heatmap.Rmd')
